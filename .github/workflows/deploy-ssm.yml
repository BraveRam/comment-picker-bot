name: Deploy via SSM

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Run deployment commands via SSM
        env:
          INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
        run: |
          COMMAND_ID="$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy comment-picker-bot from main" \
            --parameters 'commands=["sudo chown -R ubuntu:ubuntu /home/ubuntu/comment-picker-bot","sudo -u ubuntu -H bash -lc '\''git config --global --add safe.directory /home/ubuntu/comment-picker-bot'\''","sudo -u ubuntu -H bash -lc '\''cd /home/ubuntu/comment-picker-bot && git fetch origin main && git reset --hard origin/main'\''","sudo -u ubuntu -H bash -lc '\''export PM2_HOME=/home/ubuntu/.pm2; pm2 restart picko'\''"]' \
            --timeout-seconds 600 \
            --query "Command.CommandId" \
            --output text)"

          echo "SSM command id: $COMMAND_ID"

          for _ in $(seq 1 120); do
            STATUS="$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text)"

            echo "SSM status: $STATUS"

            case "$STATUS" in
              Success)
                exit 0
                ;;
              Failed|TimedOut|Cancelled)
                echo "SSM command failed with status: $STATUS" >&2
                aws ssm get-command-invocation \
                  --command-id "$COMMAND_ID" \
                  --instance-id "$INSTANCE_ID" \
                  --query "StandardErrorContent" \
                  --output text >&2
                exit 1
                ;;
            esac

            sleep 5
          done

          echo "SSM command did not complete within the expected time." >&2
          exit 1
